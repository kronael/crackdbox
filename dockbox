#!/bin/bash
# clauded - spawn dockerized claude code with isolated permissions
# Usage: clauded [project_dirs...]

set -euo pipefail

IMAGE="ghcr.io/anthropics/claude-code:latest"
CONTAINER_NAME="claude-sandbox"

# Read-only mounts (always available)
READONLY_MOUNTS=(
    "$HOME/.claude:/root/.claude:ro"
    "$HOME/.config:/root/.config:ro"
    "/etc/localtime:/etc/localtime:ro"
)

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    cat <<EOF
Usage: clauded [project_dirs...]

Examples:
    clauded                           # mounts current dir
    clauded ~/wk/project1 ~/wk/project2

Read-only mounts (hardcoded):
    ~/.claude   -> /root/.claude
    ~/.config   -> /root/.config

Project dirs are mounted at their exact paths with read-write.
EOF
    exit 0
fi

# Default to current directory
[[ $# -eq 0 ]] && set -- .

mounts=()
workdir=""

# Add read-only mounts
for m in "${READONLY_MOUNTS[@]}"; do
    src="${m%%:*}"
    [[ -e "$src" ]] && mounts+=(-v "$m")
done

# Add project directories as read-write at exact same paths
for dir in "$@"; do
    dir="$(cd "$dir" && pwd)"
    mounts+=(-v "$dir:$dir:rw")
    workdir="$dir"
done

docker pull $IMAGE

# Kill existing container if running
docker rm -f "$CONTAINER_NAME" 2>/dev/null || true

exec docker run -it --rm \
    --name "$CONTAINER_NAME" \
    -e ANTHROPIC_API_KEY \
    "${mounts[@]}" \
    -w "$workdir" \
    "$IMAGE" \
    --dangerously-skip-permissions
